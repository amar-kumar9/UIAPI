<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Management</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f4f6f9; }
        
        .header { background: #0176d3; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 18px; font-weight: 500; }
        .header button { background: white; color: #0176d3; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        
        .container { display: flex; height: calc(100vh - 48px); }
        
        .sidebar { width: 280px; background: white; border-right: 1px solid #e5e5e5; overflow-y: auto; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid #e5e5e5; font-weight: 600; }
        .case-item { padding: 12px 16px; border-bottom: 1px solid #f3f3f3; cursor: pointer; }
        .case-item:hover { background: #f9f9f9; }
        .case-item.active { background: #e8f4ff; border-left: 3px solid #0176d3; }
        .case-number { font-weight: 600; color: #0176d3; font-size: 14px; }
        .case-subject { font-size: 13px; color: #3e3e3c; margin-top: 4px; }
        .case-meta { font-size: 12px; color: #706e6b; margin-top: 4px; }
        
        .main { flex: 1; overflow-y: auto; padding: 20px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #706e6b; }
        
        .case-detail { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .detail-header { padding: 20px; border-bottom: 1px solid #e5e5e5; }
        .detail-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .detail-meta { display: flex; gap: 20px; font-size: 13px; color: #706e6b; }
        
        .tabs { display: flex; border-bottom: 1px solid #e5e5e5; padding: 0 20px; }
        .tab { padding: 12px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: #0176d3; color: #0176d3; font-weight: 600; }
        
        .tab-content { padding: 20px; }
        .feed-item { padding: 12px; border-bottom: 1px solid #f3f3f3; }
        .feed-author { font-weight: 600; font-size: 13px; }
        .feed-text { font-size: 13px; margin-top: 4px; }
        .feed-time { font-size: 12px; color: #706e6b; margin-top: 4px; }
        
        .approval-item { padding: 16px; background: #fff3cd; border-radius: 4px; margin-bottom: 12px; }
        .approval-actions { margin-top: 12px; display: flex; gap: 8px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-approve { background: #2e844a; color: white; }
        .btn-reject { background: #c23934; color: white; }
        
        .field-row { display: grid; grid-template-columns: 150px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid #f3f3f3; }
        .field-label { font-weight: 600; font-size: 13px; color: #706e6b; }
        .field-value { font-size: 13px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Case Management Console</h1>
        <button onclick="logout()">Logout</button>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                Cases
                <button onclick="showNewCaseForm()" style="float:right; font-size:12px; padding:4px 8px; background:#0176d3; color:white; border:none; border-radius:4px; cursor:pointer;">+ New</button>
            </div>
            <div id="caseList"></div>
        </div>
        
        <div class="main">
            <div id="caseDetail" class="empty-state">
                Select a case to view details
            </div>
        </div>
    </div>

    <script>
        let currentCase = null;
        let searchTimeout = null;

        async function checkAuth() {
            const res = await fetch('/profile');
            const data = await res.json();
            if (!data.loggedIn) {
                window.location.href = '/login';
            }
        }

        async function loadCases() {
            checkAuth();
            const res = await fetch('/api/cases/list');
            const data = await res.json();
            
            const list = document.getElementById('caseList');
            list.innerHTML = data.cases.records.map(c => `
                <div class="case-item" onclick="loadCase('${c.id}')">
                    <div class="case-number">${c.fields.CaseNumber.value}</div>
                    <div class="case-subject">${c.fields.Subject.value}</div>
                    <div class="case-meta">Status: ${c.fields.Status.value} | Priority: ${c.fields.Priority.value}</div>
                </div>
            `).join('');
        }

        async function loadCase(caseId) {
            const res = await fetch(`/api/cases/${caseId}`);
            const data = await res.json();
            currentCase = data;
            
            document.querySelectorAll('.case-item').forEach(el => el.classList.remove('active'));
            const activeItem = [...document.querySelectorAll('.case-item')].find(el => el.innerText.includes(data.case.fields.CaseNumber.value));
            if (activeItem) activeItem.classList.add('active');
            
            renderCaseDetail(data);
        }

        function showNewCaseForm() {
            const detail = document.getElementById('caseDetail');
            detail.innerHTML = `
                <div class="case-detail" style="padding: 20px;">
                    <div class="detail-title">Create New Case</div>
                    <div style="margin-top: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display:block; font-weight:600; margin-bottom:5px;">Subject</label>
                            <input type="text" id="newCaseSubject" oninput="handleSubjectChange(this.value)" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display:block; font-weight:600; margin-bottom:5px;">Description</label>
                            <textarea id="newCaseDescription" rows="4" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;"></textarea>
                        </div>
                        <button onclick="createCase()" style="background:#0176d3; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">Create Case</button>
                    </div>
                    
                    <div id="suggestedArticles" style="margin-top: 30px; display:none;">
                        <h3 style="font-size:16px; margin-bottom:10px; color:#444;">Suggested Articles</h3>
                        <div id="articleList"></div>
                    </div>
                </div>
            `;
            document.querySelectorAll('.case-item').forEach(el => el.classList.remove('active'));
        }

        function handleSubjectChange(value) {
            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => searchArticles(value), 500);
        }

        async function searchArticles(query) {
            if (!query || query.length < 3) {
                document.getElementById('suggestedArticles').style.display = 'none';
                return;
            }

            const res = await fetch(`/api/cases/articles?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            
            const list = document.getElementById('articleList');
            if (data.articles && data.articles.length > 0) {
                document.getElementById('suggestedArticles').style.display = 'block';
                list.innerHTML = data.articles.map(a => `
                    <div style="padding:10px; border:1px solid #eee; margin-bottom:8px; border-radius:4px; background:#f9f9f9;">
                        <a href="#" style="font-weight:600; color:#0176d3; text-decoration:none;">${a.Title}</a>
                        <div style="font-size:12px; color:#666; margin-top:4px;">${a.Summary || ''}</div>
                    </div>
                `).join('');
            } else {
                document.getElementById('suggestedArticles').style.display = 'none';
            }
        }

        async function createCase() {
            const subject = document.getElementById('newCaseSubject').value;
            const description = document.getElementById('newCaseDescription').value;

            if (!subject) {
                alert('Subject is required');
                return;
            }

            try {
                const res = await fetch('/api/cases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject, description })
                });
                
                const data = await res.json();
                if (res.ok) {
                    alert(`Case Created! Case Number: ${data.fields?.CaseNumber?.value || 'N/A'} (ID: ${data.id})`);
                    loadCases(); // Refresh list
                    // Optionally load the new case
                    // loadCase(data.id); 
                } else {
                    alert('Error creating case: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error creating case: ' + e.message);
            }
        }

        function renderCaseDetail(data) {
            const detail = document.getElementById('caseDetail');
            detail.innerHTML = `
                <div class="case-detail">
                    <div class="detail-header">
                        <div class="detail-title">${data.case.fields.Subject.value}</div>
                        <div class="detail-meta">
                            <span>Case #${data.case.fields.CaseNumber.value}</span>
                            <span>Status: ${data.case.fields.Status.value}</span>
                            <span>Priority: ${data.case.fields.Priority.value}</span>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" onclick="showTab('details')">Details</div>
                        <div class="tab" onclick="showTab('feed')">Feed (${data.feed.length})</div>
                        <div class="tab" onclick="showTab('approvals')">Approvals (${data.approvals.length})</div>
                    </div>
                    
                    <div class="tab-content" id="tabContent">
                        ${renderDetailsTab(data.case)}
                    </div>
                </div>
            `;
        }

        function renderDetailsTab(caseData) {
            return Object.entries(caseData.fields).map(([key, field]) => `
                <div class="field-row">
                    <div class="field-label">${key}</div>
                    <div class="field-value">${field.displayValue || field.value || '-'}</div>
                </div>
            `).join('');
        }

        function renderFeedTab(feed) {
            return feed.map(item => `
                <div class="feed-item">
                    <div class="feed-author">${item.actor.displayName}</div>
                    <div class="feed-text">${item.body.text}</div>
                    <div class="feed-time">${new Date(item.createdDate).toLocaleString()}</div>
                </div>
            `).join('') || '<p>No feed items</p>';
        }

        function renderApprovalsTab(approvals) {
            return approvals.map(approval => `
                <div class="approval-item">
                    <strong>${approval.name}</strong>
                    <p>Status: ${approval.status}</p>
                    <div class="approval-actions">
                        <button class="btn btn-approve" onclick="processApproval('${approval.id}', 'approve')">Approve</button>
                        <button class="btn btn-reject" onclick="processApproval('${approval.id}', 'reject')">Reject</button>
                    </div>
                </div>
            `).join('') || '<p>No pending approvals</p>';
        }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            const content = document.getElementById('tabContent');
            if (tab === 'details') content.innerHTML = renderDetailsTab(currentCase.case);
            if (tab === 'feed') content.innerHTML = renderFeedTab(currentCase.feed);
            if (tab === 'approvals') content.innerHTML = renderApprovalsTab(currentCase.approvals);
        }

        async function processApproval(approvalId, action) {
            await fetch(`/api/approvals/${approvalId}/${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comments: '' })
            });
            alert(`Approval ${action}d successfully`);
            loadCase(currentCase.case.id);
        }

        function logout() {
            window.location.href = '/logout';
        }

        loadCases();
    </script>
</body>
</html>
